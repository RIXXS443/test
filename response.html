<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Número de Cliente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            font-size: 24px;
        }
        #clienteInfo {
            margin-top: 20px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div id="clienteInfo"></div>

    <script>
        // Función para obtener el valor del parámetro de la URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Validar número de cliente (ejemplo de validación básica)
        function isValidClientNumber(clientNumber) {
            return /^[0-9]+$/.test(clientNumber); // Solo números
        }

        // Obtiene el valor del parámetro "numero_cliente"
        const numeroCliente = getQueryParam('numero_cliente');

        // Muestra el número de cliente en la página
        const clienteInfo = document.getElementById('clienteInfo');
        if (numeroCliente && isValidClientNumber(numeroCliente)) {
            clienteInfo.textContent = `Número de cliente: ${numeroCliente}`;

            // Envía una solicitud POST a la primera URL de Azure Logic Apps
            fetch('https://prod-15.westus.logic.azure.com/workflows/c56cd79374ca4842b8855d2da56db1f5/triggers/manual/paths/invoke/procesar_pedidos?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4OvqO2euKVMjSPZRsukI6GNqktVVnpPQ0Hs5qUlq5oc', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Numero_Cliente: numeroCliente
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la solicitud a la API');
                }
                return response.json();
            })
            .then(data => {
                if (data.value && Array.isArray(data.value)) {
                    const totalInvoiceAmount = data.value.reduce((sum, invoice) => sum + invoice.TotalInvoiceAmount, 0);

                    // Envía una segunda solicitud POST a la segunda URL de Azure Logic Apps con el total
                    return fetch('https://prod-66.westus.logic.azure.com/workflows/f8e056efefeb46e68d073e9be7ed89f6/triggers/manual/paths/invoke/recibir_json?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=HBKan4Ka3nBenvjnMsXvUsR7IILZfVGb_uFGPrA8xk0', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            Numero_Cliente: numeroCliente,
                            Importe: totalInvoiceAmount
                        })
                    });
                } else {
                    throw new Error('La respuesta no contiene datos válidos');
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al enviar la segunda solicitud');
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta de la segunda solicitud:', data);
                clienteInfo.innerHTML += `<p class="success">Importe total enviado: ${data.Importe}</p>`;
            })
            .catch(error => {
                console.error('Error:', error);
                clienteInfo.innerHTML += `<p class="error">Error: ${error.message}</p>`;
            });
        } else {
            clienteInfo.textContent = 'No se proporcionó un número de cliente válido.';
        }
    </script>
</body>
</html>
